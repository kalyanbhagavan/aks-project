name: Deploy App to Private AKS

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'k8s/**'
      - 'Dockerfile'
      - 'index.html'
      - '.github/workflows/deploy-app-to-aks.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'k8s/**'
      - 'Dockerfile'
      - 'index.html'
      - '.github/workflows/deploy-app-to-aks.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - staging
          - production
      skip_docker_build:
        description: 'Skip Docker build and push (use existing image)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    name: 'Deploy to Private AKS via Jumpbox'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Azure CLI
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Export Azure Service Principal credentials
        run: |
          echo "ARM_CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .clientId)" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .clientSecret)" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .subscriptionId)" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r .tenantId)" >> $GITHUB_ENV
        shell: bash

      - name: Validate Required Secrets
        run: |
          # Check if all required secrets are present
          if [[ -z "${{ secrets.JUMPBOX_IP }}" ]]; then
            echo "âŒ Error: JUMPBOX_IP secret is required"
            exit 1
          fi

          if [[ -z "${{ secrets.JUMPBOX_PASSWORD }}" ]]; then
            echo "âŒ Error: JUMPBOX_PASSWORD secret is required"
            exit 1
          fi

          if [[ -z "${{ secrets.ACR_USERNAME }}" ]]; then
            echo "âŒ Error: ACR_USERNAME secret is required"
            exit 1
          fi

          if [[ -z "${{ secrets.ACR_PASSWORD }}" ]]; then
            echo "âŒ Error: ACR_PASSWORD secret is required"
            exit 1
          fi

          if [[ -z "${{ secrets.ACR_NAME }}" ]]; then
            echo "âŒ Error: ACR_NAME secret is required"
            exit 1
          fi

          if [[ -z "${{ secrets.RESOURCE_GROUP_NAME }}" ]]; then
            echo "âŒ Error: RESOURCE_GROUP_NAME secret is required"
            exit 1
          fi

          if [[ -z "${{ secrets.AKS_CLUSTER_NAME }}" ]]; then
            echo "âŒ Error: AKS_CLUSTER_NAME secret is required"
            exit 1
          fi

          echo "âœ… All required secrets are present"

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Test Jumpbox SSH Access
        run: |
          echo "Testing SSH connectivity to jumpbox..."
          timeout 30 sshpass -p "${{ secrets.JUMPBOX_PASSWORD }}" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 azureuser@${{ secrets.JUMPBOX_IP }} "echo 'Connection successful'"

      - name: Build & Push Docker Image
        if: ${{ !github.event.inputs.skip_docker_build }}
        run: |
          echo "Building Docker image..."

          # Check if Dockerfile exists
          if [ ! -f "Dockerfile" ]; then
            echo "Creating simple NGINX Dockerfile..."
            cat > Dockerfile << 'EOF'
          FROM nginx:alpine
          COPY index.html /usr/share/nginx/html/
          EXPOSE 80
          CMD ["nginx", "-g", "daemon off;"]
          EOF
          fi

          # Check if index.html exists
          if [ ! -f "index.html" ]; then
            echo "Creating simple index.html..."
            cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>AKS Demo App</title>
              <style>
                  body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
                  .container { max-width: 600px; margin: 0 auto; }
                  .success { color: green; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ðŸš€ AKS Private Cluster Demo</h1>
                  <p class="success">âœ… Successfully deployed to private AKS cluster!</p>
                  <p>This application is running on a private Azure Kubernetes Service cluster.</p>
                  <p>Deployed via GitHub Actions and jumpbox with secure access patterns.</p>
                  <p><strong>Commit:</strong> ${{ github.sha }}</p>
                  <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
              </div>
          </body>
          </html>
          EOF
          fi

          # Build and push image with timestamp
          IMAGE_TAG="${{ github.sha }}-$(date +%s)"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_ENV

          # Login to ACR using username/password
          echo "${{ secrets.ACR_PASSWORD }}" | docker login ${{ secrets.ACR_NAME }}.azurecr.io \
            --username ${{ secrets.ACR_USERNAME }} --password-stdin

          # Build and push Docker image
          docker build -t ${{ secrets.ACR_NAME }}.azurecr.io/nginx-demo:$IMAGE_TAG .
          docker tag ${{ secrets.ACR_NAME }}.azurecr.io/nginx-demo:$IMAGE_TAG ${{ secrets.ACR_NAME }}.azurecr.io/nginx-demo:latest
          docker push ${{ secrets.ACR_NAME }}.azurecr.io/nginx-demo:$IMAGE_TAG
          docker push ${{ secrets.ACR_NAME }}.azurecr.io/nginx-demo:latest

          echo "âœ… Docker image built and pushed successfully"

      - name: Prepare k8s and script files
        run: |
          # Create directories
          mkdir -p k8s scripts

          # Create deployment manifest
          cat > k8s/deployment.yaml << 'EOF'
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: nginx-demo
            labels:
              app: nginx-demo
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: nginx-demo
            template:
              metadata:
                labels:
                  app: nginx-demo
              spec:
                containers:
                - name: nginx-demo
                  image: ACR_PLACEHOLDER.azurecr.io/nginx-demo:latest
                  ports:
                  - containerPort: 80
                  resources:
                    requests:
                      cpu: 100m
                      memory: 128Mi
                    limits:
                      cpu: 500m
                      memory: 512Mi
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: nginx-demo-lb
            labels:
              app: nginx-demo
          spec:
            type: LoadBalancer
            ports:
            - port: 80
              targetPort: 80
            selector:
              app: nginx-demo
          EOF

          # Replace ACR name placeholder
          sed -i "s|ACR_PLACEHOLDER|${{ secrets.ACR_NAME }}|g" k8s/deployment.yaml

          # Create deployment script
          cat > scripts/deploy-to-private-aks.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "Starting deployment to private AKS cluster..."

          # Install Azure CLI if not present
          if ! command -v az &> /dev/null; then
              echo "Installing Azure CLI..."
              curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          fi

          # Install kubectl if not present
          if ! command -v kubectl &> /dev/null; then
              echo "Installing kubectl..."
              curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
              sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          fi

          # Login to Azure
          echo "Logging in to Azure..."
          az login --service-principal -u "$ARM_CLIENT_ID" -p "$ARM_CLIENT_SECRET" --tenant "$ARM_TENANT_ID"
          az account set --subscription "$ARM_SUBSCRIPTION_ID"

          # Get AKS credentials
          echo "Getting AKS credentials..."
          az aks get-credentials --resource-group "$RESOURCE_GROUP" --name "$AKS_NAME" --overwrite-existing

          # Test kubectl connection
          echo "Testing kubectl connection..."
          kubectl get nodes

          # Apply Kubernetes manifests
          echo "Applying Kubernetes manifests..."
          kubectl apply -f ~/k8s/

          # Wait for deployment to be ready
          echo "Waiting for deployment to be ready..."
          kubectl rollout status deployment/nginx-demo --timeout=300s

          # Get service status
          echo "Service status:"
          kubectl get svc nginx-demo-lb

          # Get pod status
          echo "Pod status:"
          kubectl get pods -l app=nginx-demo

          echo "Deployment completed successfully!"
          EOF

          chmod +x scripts/deploy-to-private-aks.sh

          echo "âœ… Deployment files prepared"

      - name: Copy Files to Jumpbox
        run: |
          echo "Copying k8s manifests to jumpbox..."
          sshpass -p "${{ secrets.JUMPBOX_PASSWORD }}" scp -o StrictHostKeyChecking=no -r ./k8s azureuser@${{ secrets.JUMPBOX_IP }}:~/

          echo "Copying deployment script to jumpbox..."
          sshpass -p "${{ secrets.JUMPBOX_PASSWORD }}" scp -o StrictHostKeyChecking=no -r ./scripts azureuser@${{ secrets.JUMPBOX_IP }}:~/

          echo "âœ… Files copied to jumpbox successfully"

      - name: Run Deployment from Jumpbox
        run: |
          echo "Running deployment from jumpbox..."
          sshpass -p "${{ secrets.JUMPBOX_PASSWORD }}" ssh -o StrictHostKeyChecking=no azureuser@${{ secrets.JUMPBOX_IP }} << 'SSH_EOF'
            # Set environment variables for the script
            export ARM_CLIENT_ID="${{ env.ARM_CLIENT_ID }}"
            export ARM_CLIENT_SECRET="${{ env.ARM_CLIENT_SECRET }}"
            export ARM_SUBSCRIPTION_ID="${{ env.ARM_SUBSCRIPTION_ID }}"
            export ARM_TENANT_ID="${{ env.ARM_TENANT_ID }}"

            # Set configuration variables
            export RESOURCE_GROUP="${{ secrets.RESOURCE_GROUP_NAME }}"
            export AKS_NAME="${{ secrets.AKS_CLUSTER_NAME }}"

            # Make script executable and run it
            chmod +x ~/scripts/deploy-to-private-aks.sh
            bash ~/scripts/deploy-to-private-aks.sh
          SSH_EOF

          echo "âœ… Deployment completed successfully"

      - name: Get App URL
        id: get-url
        run: |
          echo "Getting application URL..."
          for i in {1..10}; do
              EXTERNAL_IP=$(sshpass -p "${{ secrets.JUMPBOX_PASSWORD }}" ssh -o StrictHostKeyChecking=no azureuser@${{ secrets.JUMPBOX_IP }} \
                "kubectl get svc nginx-demo-lb -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo ''")

              if [[ -n "$EXTERNAL_IP" && "$EXTERNAL_IP" != "<none>" && "$EXTERNAL_IP" != "null" ]]; then
                  echo "app_url=http://$EXTERNAL_IP" >> $GITHUB_OUTPUT
                  echo "âœ… Application URL: http://$EXTERNAL_IP"
                  break
              fi
              echo "Waiting for LoadBalancer IP... (attempt $i/10)"
              sleep 15
          done

          if [[ -z "$EXTERNAL_IP" || "$EXTERNAL_IP" == "<none>" || "$EXTERNAL_IP" == "null" ]]; then
              echo "âš ï¸ Warning: LoadBalancer IP not available yet"
              echo "app_url=LoadBalancer IP pending..." >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### ðŸš€ App Deployed to Private AKS Successfully!

            **Application URL:** ${{ steps.get-url.outputs.app_url }}

            **Deployed Resources:**
            - âœ… NGINX Deployment (2 replicas)
            - âœ… LoadBalancer Service
            - âœ… RBAC for dev team
            - âœ… Azure Files integration

            **Infrastructure:**
            - ðŸ”’ Private AKS Cluster
            - ðŸ”’ Private ACR
            - ðŸ”’ Deployed via jumpbox

            *Deployed via GitHub Actions to private AKS cluster*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Deployment Summary
        run: |
          echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application URL:** ${{ steps.get-url.outputs.app_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Infrastructure Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- AKS Cluster: ${{ secrets.AKS_CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- ACR: ${{ secrets.ACR_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- Resource Group: ${{ secrets.RESOURCE_GROUP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- Jumpbox IP: ${{ secrets.JUMPBOX_IP }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Method:** Private AKS via jumpbox" >> $GITHUB_STEP_SUMMARY